---
description: "LocalBot AI â€“ Security, authentication, and authorization"
globs: ["src/**/*.ts", "src/app/api/**/*.ts"]
alwaysApply: true
---
# ğŸ” SECURITY & AUTHORIZATION

## ğŸ†” AUTHENTICATION:
- **Supabase Auth** â€“ NO custom auth, NO NextAuth.js.
- **Middleware**: `src/middleware.ts` protects ALL `/dashboard/*` routes.
- **Session**: Always use `@supabase/auth-helpers-nextjs` server/client components.

## ğŸ›¡ï¸ AUTHORIZATION â€“ CRITICAL:
**EVERY API ROUTE THAT MODIFIES DATA MUST:**
1. âœ… Verify user is authenticated (get user from Supabase session)
2. âœ… Verify user owns the resource (check `user_id` match)
3. âœ… Return `401` or `403` with clear error message
4. âœ… NEVER trust client-side IDs without ownership verification

## ğŸ”‘ API KEYS & SECRETS:
- **NEVER** expose `OPENAI_API_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `STRIPE_SECRET_KEY` to client.
- **NEVER** commit `.env.local` â€“ it's in `.gitignore`.
- **NEVER** hardcode secrets in source files.

## ğŸ“¦ RLS (ROW LEVEL SECURITY):
- ALL Supabase tables must have RLS enabled.
- ALL RLS policies must restrict access to authenticated user's own data.
- Test RLS policies with `service_role` vs `anon` key.

## ğŸš¦ RATE LIMITING:
- **Chat API**: 10 requests/minute per embed token.
- **Auth endpoints**: 5 requests/minute per IP.
- **Crawl API**: 3 requests/hour per user (free tier), 20/hour (paid).

## âš ï¸ IF UNSURE ABOUT SECURITY IMPLICATIONS: ASK.
